{
  "enabled": true,
  "name": "API Postman Collection Sync",
  "description": "Monitors API source code changes and automatically syncs the Postman collection by diffing endpoints and updating missing/changed requests",
  "version": "3",
  "when": {
    "type": "userTriggered"
  },
  "then": {
    "type": "askAgent",
    "prompt": "API source code or integration tests have been modified. Perform a diff-based sync of the Postman collection:\n\n## Step 1: Discover All Endpoints\n1. Read .postman.json to get collection_id and workspace_id\n2. Scan ALL backend/app/api/*.py files to extract every API endpoint:\n   - Parse @router decorators (GET, POST, PUT, DELETE, PATCH)\n   - Extract path, method, request body schemas, response schemas\n   - Note: Use grepSearch to find all @router patterns across API files\n3. For each discovered endpoint, find corresponding integration tests in backend/tests/test_*_api_integration.py:\n   - Extract test assertions (status codes, response structure, error cases)\n   - Extract example request bodies from test code\n   - Extract expected response validation logic\n\n## Step 2: Get Current Collection State\n1. Use Postman power's getCollection to retrieve current collection\n2. Build a map of existing endpoints: {method + path: request_details}\n3. Extract existing test scripts from each request\n\n## Step 3: Diff Analysis\nFor each discovered endpoint:\n- **MISSING**: Endpoint exists in code but NOT in collection → ADD\n- **OUTDATED**: Endpoint exists in both, but tests changed → UPDATE test scripts\n- **UNCHANGED**: Endpoint and tests match → SKIP\n\n## Step 4: Sync Collection\nFor MISSING endpoints:\n- Use createCollectionRequest with:\n  - HTTP method and full URL ({{base_url}}/api/...)\n  - Request body from test examples\n  - Test scripts generated from integration test assertions:\n    ```javascript\n    pm.test(\"Status code is 200\", function () {\n        pm.response.to.have.status(200);\n    });\n    pm.test(\"Response has required fields\", function () {\n        var jsonData = pm.response.json();\n        pm.expect(jsonData).to.have.property('field_name');\n    });\n    ```\n\nFor OUTDATED endpoints:\n- Document which endpoints need test script updates\n- Note: Postman API limitation - cannot update individual requests, only full collection replacement\n- Provide manual update instructions with exact test scripts to add\n\n## Step 5: Summary Report\nProvide:\n- Total endpoints discovered in code: X\n- Endpoints in collection: Y\n- Missing endpoints added: Z\n- Outdated endpoints (manual update needed): W\n- List of all changes made\n\n## Important Notes\n- Focus on recently modified files but scan ALL API files for complete diff\n- Generate test scripts that match pytest assertion patterns\n- Handle edge cases: optional parameters, error responses, validation failures\n- If Postman API fails to persist details, document the limitation and provide manual instructions"
  }
}
